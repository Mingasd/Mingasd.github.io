---
layout: post
title: MongoDB学习笔记
data: 2022-08-14
tags: [数据库]
---

### 简介

MongoDB是一种文档数据库，不同与关系型数据库，它没有Scheme。MongoDB 使用面向文档的数据模型，导致很多概念都与 RDBMS 有一些差别，虽然从总体上来看两者都有相对应的概念。

![](https://raw.githubusercontent.com/Mingasd/PostImg/main/mongoDB%E4%B8%8EMysql%E5%AF%B9%E6%AF%94.png)

#### 读偏好

MongoDB支持设置读偏好，有以下几种选项可配置：

- **primary**：这是**默认**的设置，表明只从可复制集的主节点读取数据，因此具有强一致性。如果可复制集有问题，并且没有可选举的从节点，就表示出现错误。primary是唯一一个可以确保**读一致**的模式。
- **premaryPreferred** ： 设置了此参数的驱动会从主节点读取数据，除非某些原因使主节点不可用或者没有主节点，此时它会从从节点读取数据。此种设置下，读请求无法保证一致性。
- **secondary** ：这个设置告诉驱动应该一直从从节点读取数据。这种设置对于我们想确保读请求不会影响主节点的写入请求时非常有用。如果没有可用的从节点，读请求会抛出异常。
- **secondarypreferred**：读请求会发出到从节点，除非没有从节点可用，此时才会从主节点读取。
- **nearest** –驱动会尝试从最近的可复制集成员节点读取读取数据，通过网络延迟判断。可以是主节点也可以是从节点。因此**读请求只会发送给驱动认为最快通信的节点**。

### 事务

事务与session是关联的，在任何给定时间，一个会话最多只能有一个未完成的事务。分布式系统在实际应用中也要面临着访问延迟和一致性之间的权衡，MongoDB使用读写关注进行配置。

#### 写关注

事务使用事务级别的写关注进行写操作，可以在事务开始时设置事务级别的写关注，带有写关注的操作会等到数据库确认成功写入后才能返回，**因此写关注会带来性能上的损失。**

- 如果未设置事务级写关注，则事务级写关注默认为提交的会话级写关注。

- 如果未设置事务级写关注和会话级写关注，则事务级写关注默认为客户端级写关注。 默认情况下，客户端级别的写入问题为`w:1`。

  - `w:1`：只针对primary节点的确认返回

  - `w:majority`：多数有投票权的节点确认返回

#### 读关注

事务使用事务级别的读关注进行读操作，控制读取数据的"新鲜度"和持久性。

- 如果未设置事务级读关注，则事务级读关注默认为会话级读关注。

- 如果未设置事务级别和会话级别的读关注，则事务级别的读取关注点默认为客户端级别的读关注。 默认情况下，对于主服务器的读取，客户端级别的读关注为`local`。 

  - local：默认是针对主节点读，直接读取本地最新的数据，但不保证该数据已被写入大多数复制集成员，数据可能会被回滚。

  - majority：读取多数有投票权的节点已经确认的数据，可以保证读取的数据不会被回滚，但是并不能保证读到本地最新的数据。

  - snapshot：多文档事务而设计的，只能用在显式开启的多文档事务中。如果事务是因果一致会话的一部分，且写关注为 majority，则在事务提交后，读操作可以保证已从多数提交数据的快照中读取，该快照提供与该事务开始之前的操作的因果一致性。所有的读都将使用同一个快照，直到事务提交为止该快照才被释放。
